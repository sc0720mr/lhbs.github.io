<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-96GTJYY7RC"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-96GTJYY7RC');
    </script>
    <meta charset="UTF-8">
    <meta name="description" content="水蓮山莊社區巴士及519, F913公車時刻表及停靠站點資訊">
    <meta name="keywords" content="水蓮山莊, 社區巴士, 社巴, 公車, 591公車, F913公車, F913公車延駛">
    <meta name="author" content="城市不動產-張瀚文">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="icon/apple-touch-icon-57x57.png" />
    <link rel="stylesheet" href="css/lhbs.css?v=1.0.7" />
    <title>水蓮山莊社區巴士及公車時刻表</title>
</head>
<body>
    <header>
        <a href="index.html" class="home">
            <div>
                <h1>水蓮社巴及公車時刻表</h1>
                <p>Lotus Hill Bus Schedule</p>
            </div>
        </a>
        <a href="javascript:void(0)" onclick="resetSchedule()" class="reset"><i class="fa-solid fa-rotate-right"></i></a>
    </header>
    <div id="warning" style="display: none;">
        <div class="warning-container">
            <div class="alert-icon">提醒</div>
            <div class="warningInfo">
                <i class="fa-solid fa-circle-exclamation"></i> 114.04.03 ~ 114.04.06 社巴為『假日』班次，請住戶們多加留意。
            </div>
        </div>
    </div>

    <input id="tab1" type="radio" name="tabs" class="tabTrigger" checked>
    <label for="tab1" class="visualTab"><i class="fa-solid fa-clock"></i> 時刻表</label>
    <input id="tab2" type="radio" name="tabs" class="tabTrigger">
    <label for="tab2" class="visualTab"><i class="fa-solid fa-location-dot"></i> 停站點</label>
    <input id="tab3" type="radio" name="tabs" class="tabTrigger">
    <label for="tab3" class="visualTab"><i class="fa-solid fa-phone"></i> 電話</label>
    <input id="tab4" type="radio" name="tabs" class="tabTrigger">
    <label for="tab4" class="visualTab"><i class="fa-solid fa-circle-info"></i> 關於</label>

    <section id="content1">
        <div class="filterFunction">
            <select id="dayType" class="custom-select">
                <option value="workday">平日</option>
                <option value="holiday">假日</option>
            </select>
            <label><input type="radio" name="tripType" value="to" checked> 去程(出水蓮)</label>
            <label><input type="radio" name="tripType" value="from"> 回程(回水蓮)</label>
        </div>

        <div class="filterbtn">
            <button onclick="getUserLocation()" class="orange"><i class="fa-solid fa-magnifying-glass"></i>以現在時間搜尋最接近班次</button>
        </div>

        <div class="container">
            <div id="nearestStop"></div>
            <div id="scheduleContainer" class="schedule-container"></div>
        </div>
    </section>

    <section id="content2">
        <!-- 其他內容保持不變 -->
    </section>

    <section id="content3">
        <!-- 其他內容保持不變 -->
    </section>

    <section id="content4">
        <!-- 其他內容保持不變 -->
    </section>

    <footer>
        <div>Ver. 114.02.04 / Build：2024.11.05(V2)</div>
        <div>Copyright &copy; 2024 Steven Chang. All rights reserved.</div>
    </footer>

    <script src="js/lhbs_114.js?v=1.0.31 defer"></script>
    <script>
        const busStops = [
            { name: "水蓮山莊", lat: 25.0756958, lng: 121.6329477, direction: "to" },
            { name: "金龍里", lat: 25.0858013, lng: 121.5962172, direction: "to" },
            { name: "民族六街市場口", lat: 25.07065685499145, lng: 121.62934897496015, direction: "to" },
            { name: "金龍國小", lat: 25.0685754, lng: 121.6277344, direction: "to" },
            { name: "東湖捷運站", lat: 25.066848, lng: 121.611427, direction: "from" },
            // 可以在這裡添加其他的巴士停靠點
        ];

        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                alert("這個瀏覽器不支援地理位置。");
            }
        }

        function showPosition(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            findNearestBusStop(userLat, userLng);
        }

        function showError(error) {
            console.error("獲取位置時發生錯誤：", error);
            alert("無法獲取您的位置。");
        }

        function findNearestBusStop(userLat, userLng) {
            const direction = document.querySelector('input[name="tripType"]:checked').value; // 獲取選中的方向
            let nearestStop = null;
            let minDistance = Infinity;

            busStops.forEach(stop => {
                if (stop.direction === direction) { // 檢查停靠點是否匹配選擇的方向
                    const distance = haversineDistance(userLat, userLng, stop.lat, stop.lng);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestStop = stop;
                    }
                }
            });

            if (nearestStop) {
                displayNearestStop(nearestStop, minDistance);
            } else {
                document.getElementById('nearestStop').innerHTML = '未找到最近的停靠站。';
            }
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球半徑 (公里)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); 
            return R * c; // 返回距離 (公里)
        }

        function displayNearestStop(stop, distance) {
            const nearestStopInfo = `
                您目前距離最近的停站點是:
                <a href="https://www.google.com/maps/dir/?api=1&destination=${stop.lat},${stop.lng}" target="_blank">${stop.name}</a> (距離約 ${distance.toFixed(2)} 公里)`;
            document.getElementById('nearestStop').innerHTML = nearestStopInfo;
        }

        window.onload = function() {
            getUserLocation(); // 加載時獲取用戶位置
        };
    </script>
</body>
</html>